{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Inicio{% endblock %}


{% block dashboard_content %}

  <div class="title-wrapper pt-30 mb-20" >
    <div class="row align-items-center">
      <div class="col-md-12">
        <h2>Flujo en Tiempo Real</h2>
      </div>
    </div>
  </div>

  <div class="row" id="sensorContainer">
    <div class="col-12">
        <p class="text-center text-gray pt-5 mb-20" id="loading-message">
            Conectando con el servidor de datos en tiempo real...
        </p>
    </div>
  </div>

  <div class="card bg-dark mb-4" style="border: 1px solid rgba(255, 255, 255, 0.1);">
    <div class="card-header py-3 bg-dark" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
        <h6 class="m-0 font-weight-bold text-light">Historial de Consumo Reciente</h6>
    </div>
    
    <div class="card-body">
        <ul class="list-group overflow-auto" style="max-height: 400px;" id="historial-lista">
            <li class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                Cargando historial...
            </li>
        </ul>
    </div>
  </div>

 

{% endblock %}


{% block page_scripts %}
  
  <script>
    // --- Lógica del Dashboard Principal ---
    
    const sensors = {}; 
    const sensorContainer = document.getElementById("sensorContainer");
    const loadingMessage = document.getElementById("loading-message");

    // -----------------------------------------------------------------
    // FUNCIÓN: Crear Tarjeta de Sensor
    // -----------------------------------------------------------------
    function createSensorCard(data) {
        const key = data.sensor_id;
        if (sensors[key]) return; 
        if (loadingMessage) loadingMessage.remove();

        const cardCol = document.createElement("div");
        cardCol.classList.add("col-lg-6", "col-md-6"); 
        cardCol.id = `col_${key}`;
        cardCol.innerHTML = `
            <div class="card-style mb-30 sensor-realtime-card">
                <div class="title d-flex justify-content-between align-items-center">
                    <h6 class="text-medium mb-10">${data.sensor_id} (Cliente: ${data.cliente_id})</h6>
                    <span class="text-sm ${data.is_initial_data ? 'text-muted' : 'text-success'}" id="${key}_status">
                      ${data.is_initial_data ? 'Última lectura DB' : 'En vivo'}
                    </span>
                </div>
                <div class="d-flex align-items-end mb-20">
                    <h3 class="valor" id="${key}_valor">--</h3>
                    <p class="ms-2">L/min</p>
                </div>
                <div class="chart-container-realtime">
                    <canvas id="${key}_chart"></canvas>
                </div>
            </div>
        `;
        sensorContainer.prepend(cardCol);

        const ctx = document.getElementById(`${key}_chart`).getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Flujo (L/s)',
                    data: [],
                    borderColor: 'rgba(0,123,255,1)',
                    backgroundColor: 'rgba(0,123,255,0.2)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { display: false }, 
                    y: { beginAtZero: true } 
                }
            }
        });
        
        sensors[key] = { chart, valores: [] };
        updateSensorValue(data);
    }

    // -----------------------------------------------------------------
    // FUNCIÓN: Actualizar Valor de Sensor
    // -----------------------------------------------------------------
    function updateSensorValue(data) {
        const key = data.sensor_id;
        const sensor = sensors[key];
        if (!sensor) return; 

        const flowValue = parseFloat(data.flujo).toFixed(2);
        
        document.getElementById(`${key}_valor`).textContent = flowValue;

        if (!data.is_initial_data) {
            const statusEl = document.getElementById(`${key}_status`);
            statusEl.textContent = 'En vivo';
            statusEl.classList.remove('text-muted');
            statusEl.classList.add('text-success');
        }

        sensor.valores.push(data.flujo);
        const maxDataPoints = 30;
        if (sensor.valores.length > maxDataPoints) sensor.valores.shift(); 
        
        sensor.chart.data.labels = Array(sensor.valores.length).fill(""); 
        sensor.chart.data.datasets[0].data = sensor.valores;
        sensor.chart.update('quiet');
    }

    // -----------------------------------------------------------------
    // 1. CARGA INICIAL DE DATOS (Fetch)
    // -----------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- Fetch para los GRÁFICOS en vivo ---
        fetch("{% url 'api_inicio_data' %}")
            .then(response => response.json())
            .then(initialData => {
                if (initialData.length > 0) {
                    initialData.forEach(sensorData => {
                        createSensorCard(sensorData);
                    });
                } else {
                    if (loadingMessage) loadingMessage.textContent = "No tienes sensores registrados.";
                }
            })
            .catch(err => {
                console.error("Error cargando datos iniciales:", err);
                if (loadingMessage) loadingMessage.textContent = "Error al cargar datos.";
            });

        // --- Fetch para el HISTORIAL RECIENTE (Restaurado) ---
        
        // Función de ayuda para formatear la fecha
        function formatearFecha(fechaISO) {
            const opciones = { 
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit' 
            };
            return new Date(fechaISO).toLocaleString('es-CL', opciones);
        }

        fetch('/api/historial/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar el historial');
                }
                return response.json();
            })
            .then(data => {
                const lista = document.getElementById('historial-lista');
                lista.innerHTML = ''; // Limpiar "Cargando..."
    
                if (data.length === 0) {
                    lista.innerHTML = '<li class="list-group-item list-group-item-dark">No hay datos históricos.</li>';
                    return;
                }
    
                // Lógica de renderizado que faltaba
                data.forEach(lectura => {
                    const item = document.createElement('li');
                    // Asegúrate de que las clases coincidan con tu CSS
                    item.className = 'list-group-item list-group-item-dark d-flex justify-content-between align-items-center'; 
                    
                    item.innerHTML = `
                        <span>
                            <strong>${lectura.sensor_nombre}:</strong> 
                            ${lectura.valor.toFixed(2)} L/min
                        </span>
                        <small class="text-light">${formatearFecha(lectura.timestamp)}</small>
                    `;
                    
                    lista.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Error en fetch historial:', error);
                const lista = document.getElementById('historial-lista');
                lista.innerHTML = '<li class="list-group-item text-danger">No se pudo cargar el historial.</li>';
            });
    });

    // -----------------------------------------------------------------
    // 2. CONEXIÓN WEBSOCKET (Para datos en vivo)
    // -----------------------------------------------------------------
    const ws = new WebSocket("ws://" + window.location.host + "/ws/sensores/");

    ws.onopen = () => {
        console.log("WebSocket conectado.");
        if (loadingMessage && loadingMessage.textContent.includes("Conectando")) {
             loadingMessage.textContent = "Esperando datos de sensores...";
        }
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const key = data.sensor_id;
        
        if (!sensors[key]) {
            createSensorCard(data);
        } else {
            updateSensorValue(data);
        }
    };
    
    ws.onclose = () => { console.log("WebSocket desconectado."); };
    ws.onerror = (err) => { console.error("Error en WebSocket:", err); };

  </script>
{% endblock %}