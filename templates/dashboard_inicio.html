{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Inicio{% endblock %}


{% block dashboard_content %}

  <div class="title-wrapper pt-30 mb-20" >
    <div class="row align-items-center">
      <div class="col-md-12">
        <h2>Panel de Control - Flujo en Tiempo Real</h2>
      </div>
    </div>
  </div>

  <div class="row" id="sensorContainer">
    <div class="col-12">
        <p class="text-center text-gray pt-5 mb-20" id="loading-message">
            Conectando con el servidor de datos en tiempo real...
        </p>
    </div>
  </div>

  <div class="card bg-dark mb-4" style="border: 1px solid rgba(255, 255, 255, 0.1);">
    <div class="card-header py-3 bg-dark" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
        <h6 class="m-0 font-weight-bold text-light">Historial de Consumo Reciente</h6>
    </div>
    
    <div class="card-body">
        <ul class="list-group overflow-auto" style="max-height: 400px;" id="historial-lista">
            <li class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                Cargando historial...
            </li>
        </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-12">
        <div class="card-style mb-30">
            <div class="title d-flex justify-content-between align-items-center">
                <h6 class="text-medium mb-30 margin-left-20">Controles Generales del Sistema</h6>
            </div>
            <div class="d-flex flex-wrap gap-3">
                <button style="border-radius: 10px;" class="btn btn-primary btn-sm rounded-10" aria-label="Leer medidor">Leer Medidor Global</button>
            </div>
        </div>
    </div>
  </div>

{% endblock %}


{% block page_scripts %}
  
  <script>
      const ws = new WebSocket("ws://" + window.location.host + "/ws/sensores/");
      const sensors = {}; // guardará datos de cada sensor y su objeto Chart
      const sensorContainer = document.getElementById("sensorContainer");
      const loadingMessage = document.getElementById("loading-message");

      ws.onopen = () => {
          console.log("WebSocket conectado.");
          if (loadingMessage) loadingMessage.textContent = "Esperando datos de sensores...";
      };
      ws.onclose = () => {
          console.log("WebSocket desconectado.");
          if (loadingMessage) loadingMessage.textContent = "Conexión WebSocket cerrada. Intentando reconectar...";
      };
      ws.onerror = (err) => {
          console.error("Error en WebSocket:", err);
          if (loadingMessage) loadingMessage.textContent = "Error de conexión WebSocket.";
      };

      ws.onmessage = (event) => {
          const data = JSON.parse(event.data); // {cliente_id, sensor_id, flujo}
          const key = data.sensor_id;
          
          if (loadingMessage) loadingMessage.remove();

          if (!sensors[key]) {
              const cardCol = document.createElement("div");
              cardCol.classList.add("col-lg-6", "col-md-6"); 
              cardCol.id = `col_${key}`;
              cardCol.innerHTML = `
                  <div class="card-style mb-30 sensor-realtime-card">
                      <div class="title d-flex justify-content-between align-items-center">
                          <h6 class="text-medium mb-10">${data.sensor_id} Cliente: ${data.cliente_id})</h6>
                          <span class="text-sm text-success">Flujo en Vivo</span>
                      </div>
                      <div class="d-flex align-items-end mb-20">
                          <h3 class="valor" id="${key}_valor">--</h3>
                          <p class="ms-2">L/s</p>
                      </div>
                      <div class="chart-container-realtime">
                          <canvas id="${key}_chart"></canvas>
                      </div>
                  </div>
              `;
              sensorContainer.prepend(cardCol); // Añadir al inicio

              const ctx = document.getElementById(`${key}_chart`).getContext('2d');
              const chart = new Chart(ctx, {
                  type: 'line',
                  data: {
                      labels: [],
                      datasets: [{
                          label: 'Flujo (L/s)',
                          data: [],
                          borderColor: 'rgba(0,123,255,1)',
                          backgroundColor: 'rgba(0,123,255,0.2)',
                          tension: 0.3,
                          fill: true,
                          pointRadius: 0
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: { legend: { display: false } },
                      scales: { 
                          x: { display: false }, 
                          y: { beginAtZero: true } 
                      }
                  }
              });

              sensors[key] = { chart, valores: [] };
          }

          document.getElementById(`${key}_valor`).textContent = parseFloat(data.flujo).toFixed(2);
          const sensor = sensors[key];
          sensor.valores.push(data.flujo);

          const maxDataPoints = 30;
          if (sensor.valores.length > maxDataPoints) sensor.valores.shift(); 
          
          sensor.chart.data.labels = Array(sensor.valores.length).fill(""); 
          sensor.chart.data.datasets[0].data = sensor.valores;
          sensor.chart.update('quiet');
      };
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        function formatearFecha(fechaISO) {
            const opciones = { 
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit' 
            };
            return new Date(fechaISO).toLocaleString('es-CL', opciones);
        }
    
        fetch('/api/historial/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar el historial');
                }
                return response.json();
            })
            .then(data => {
                const lista = document.getElementById('historial-lista');
                lista.innerHTML = '';
    
                if (data.length === 0) {
                    lista.innerHTML = '<li class="list-group-item">No hay datos históricos.</li>';
                    return;
                }
    
                data.forEach(lectura => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    item.innerHTML = `
                        <span>
                            <strong>${lectura.sensor_nombre}:</strong> 
                            ${lectura.valor} L/min
                        </span>
                        <small class="text-light">${formatearFecha(lectura.timestamp)}</small>
                    `;
                    
                    lista.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Error en fetch historial:', error);
                const lista = document.getElementById('historial-lista');
                lista.innerHTML = '<li class="list-group-item text-danger">No se pudo cargar el historial.</li>';
            });
    
    });
  </script>
{% endblock %}