{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Mapa{% endblock %}

{% block page_styles %}
  <link rel="stylesheet" href="{% static 'dist/leaflet.css' %}" />
  <style>
    /* Override container padding for full width map on this page only */
    .main-content .container-fluid {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    
    /* Ensure the section doesn't add extra padding if possible, 
       though .section usually has padding-top. We can keep that. */

    #mapa-container {
      height: 85vh; /* Occupy most of the vertical space */
      width: 100%;
      border-radius: 0; /* No rounded corners */
      z-index: 1; 
    }
    
    .sensor-popup-content h4 {
        margin-top: 0;
        font-size: 1.1em;
        color: #007bff;
    }
    .sensor-popup-content .valor-flujo {
        font-size: 1.8em;
        font-weight: bold;
        color: #28a745; /* Verde (En vivo) */
    }
    .sensor-popup-content .text-muted-db {
        font-size: 1.8em;
        font-weight: bold;
        color: #adb5bd; /* Gris (Histórico) */
    }
    
    /* Estilo para que el control de capas se vea bien sobre tu fondo */
    .leaflet-control-layers {
        background: #fff;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
  </style>
{% endblock %}


{% block dashboard_content %}
  <div class="row g-0">
    <div class="col-12">
        <div id="mapa-container"></div>
    </div>
  </div>
{% endblock %}


{% block page_scripts %}
  <script src="{% static 'dist/leaflet.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      
      const owmApiKey = '{{ OWM_API_KEY|escapejs }}';


      const markers = {}; 
      var map = L.map('mapa-container').setView([-35.6751, -71.5430], 6);
      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      });

      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      });

      // --- Definición de Capas de Clima (Superpuestas) ---
      const weatherPrecipitation = L.tileLayer(
          `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${owmApiKey}`, 
          {
              maxZoom: 18,
              opacity: 0.7,
              attribution: '© OpenWeatherMap'
          }
      );
      
      const weatherTemp = L.tileLayer(
          `https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${owmApiKey}`, 
          {
              maxZoom: 18,
              opacity: 0.5,
              attribution: '© OpenWeatherMap'
          }
      );

      const baseLayers = {
          "OpenStreetMap": osmLayer,
          "Satélite": satelliteLayer
      };

      const overlayLayers = {
          "Precipitación": weatherPrecipitation,
          "Temperatura": weatherTemp
      };

      L.control.layers(baseLayers, overlayLayers).addTo(map);

      osmLayer.addTo(map);

      var locations = JSON.parse('{{ locations_json|escapejs }}'); 
      var marcadores_coords = [];

      locations.forEach(function(loc) {
        
        const initialValue = parseFloat(loc.last_value).toFixed(2);
        let displayValue, valueClass, statusText;
        
        if (initialValue === '0.00' || initialValue === '0.0') {
            displayValue = '-- L/min';
            valueClass = 'text-muted-db';
            statusText = 'Sin datos históricos';
        } else {
            displayValue = `${initialValue} L/min`;
            valueClass = 'valor-flujo'; 
            statusText = 'Última lectura DB';
        }
        
        const initialPopupContent = `
          <div class="sensor-popup-content" id="popup_${loc.id_mqtt}">
            <h4>${loc.nombre}</h4>
            <p>ID: ${loc.id_mqtt}</p>
            <hr style="margin: 5px 0;">
            <p style="margin-bottom: 0;">Flujo:</p>
            <div class="${valueClass}" data-sensor-id="${loc.id_mqtt}">${displayValue}</div>
            <small class="text-muted" data-status-id="${loc.id_mqtt}">${statusText}</small>
          </div>
        `;

        // CREAR MARCADOR Y BIND POPUP
        var marker = L.marker([loc.lat, loc.lon]).addTo(map)
          .bindPopup(initialPopupContent, {
            autoPan: true, 
            closeButton: false,
          });

        // Se dispara CADA VEZ que el popup se abre.
        marker.on('popupopen', function (e) {
            var popup = e.popup;
            const dataUrl = "{% url 'api_popup_data' id_mqtt='HTMX_ID_REPLACE' %}".replace('HTMX_ID_REPLACE', loc.id_mqtt);

            fetch(dataUrl)
                .then(response => {
                    if (!response.ok) { throw new Error('Error de red'); }
                    return response.text();
                })
                .then(html => {

                    popup.setContent(html);
                })
                .catch(err => {
                    console.error("Error al refrescar popup:", err);
                });
        });
        
        // Almacenar marcador para WebSocket
        markers[loc.id_mqtt] = { marker: marker };
        marcadores_coords.push([loc.lat, loc.lon]);
      });

      if (marcadores_coords.length > 0) {
        var bounds = L.latLngBounds(marcadores_coords);
        map.fitBounds(bounds);
      }

      const ws = new WebSocket("ws://" + window.location.host + "/ws/sensores/");

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data); 
        const sensorId = data.sensor_id;
        const flowRate = parseFloat(data.flujo).toFixed(2);
        
        // Solo actualiza si el popup está ABIERTO
        const popupContentElement = document.getElementById(`popup_${sensorId}`);

        if (popupContentElement) {
            const valueElement = popupContentElement.querySelector(`[data-sensor-id="${sensorId}"]`);
            const statusElement = popupContentElement.querySelector(`[data-status-id="${sensorId}"]`);
            
            if (valueElement) {
              valueElement.classList.remove('text-muted-db');
              valueElement.classList.add('valor-flujo');
              valueElement.textContent = `${flowRate} L/min`;
            }
            if(statusElement) {
                statusElement.textContent = `En vivo: ${new Date().toLocaleTimeString('es-CL')}`;
            }
        }
      };

      ws.onerror = (err) => { console.error("Error en WebSocket del mapa:", err); };
      ws.onopen = () => { console.log("WebSocket conectado al mapa."); };
      ws.onclose = () => { console.log("WebSocket desconectado del mapa."); };

    });
  </script>
{% endblock %}