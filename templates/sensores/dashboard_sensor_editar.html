{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Editar Sensor{% endblock %}

{# --- Bloque 1: ESTILOS (¡NUEVO!) --- #}
{% block page_styles %}
  {# Necesitamos el CSS de Leaflet #}
  <link rel="stylesheet" href="{% static 'dist/leaflet.css' %}" />
  <style>
    #mapa-ingreso {
      height: 450px; 
      width: 100%;
      border-radius: 10px;
      z-index: 1;
      background-color: #555;
    }
    .leaflet-container {
      cursor: crosshair !important;
    }
    .map-helper-text {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      z-index: 401;
      pointer-events: none;
    }
    .form-label {
        color: #f1f1f1;
    }
    .text-muted {
        color: #adb5bd !important;
    }

    .btn-artista-azul {
      position: relative;
      display: inline-block;
      padding: 10px 20px; 
      font-size: 14px; 
      font-weight: 600;
      color: white;
      text-align: center;
      text-decoration: none;
      background: linear-gradient(90deg, #0825df, #051627);
      border: none;
      border-radius: 5px; 
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    .btn-artista-azul:hover {
      transform: translateY(-3px); 
      box-shadow: 0 7px 12px rgba(0, 0, 0, 0.3);
      filter: brightness(1.1); 
    }

    .btn-artista-rojo {
      position: relative;
      display: inline-block;
      padding: 10px 20px; 
      font-size: 14px; 
      font-weight: 600;
      color: white;
      text-align: center;
      text-decoration: none;
      background: linear-gradient(90deg, #f70505, #600803);
      border: none;
      border-radius: 5px; 
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    .btn-artista-rojo:hover {
      transform: translateY(-3px); 
      box-shadow: 0 7px 12px rgba(0, 0, 0, 0.3);
      filter: brightness(1.1); 
    }
  </style>
{% endblock %}


{% block dashboard_content %}

  <div class="title-wrapper pt-30 mb-20">
    <div class="row align-items-center">
      <div class="col-md-12">
        <p class="text-muted">Editando: {{ dispositivo.nombre|default:dispositivo.id_dispositivo_mqtt }}</p>
      </div>
    </div>
  </div>

  <div class="card-style">
    <div class="card-body">
      
      <form method="POST">
        {% csrf_token %}

        <div class="row">

          <div class="col-md-5">
            <h5 class="mb-30">Detalles del Dispositivo</h5>

            <div class="mb-3">
              <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}</label>
              {{ form.nombre }}
            </div>

            <div class="mb-3">
              <label for="{{ form.id_dispositivo_mqtt.id_for_label }}" class="form-label">{{ form.id_dispositivo_mqtt.label }}</label>
              {{ form.id_dispositivo_mqtt }}
               
            </div>

            <hr class="my-4" style="border-color: rgba(255,255,255,0.1);">

 

              {{ form.latitud }}
              {{ form.longitud }}

          </div>

          <div class="col-md-7">
            <div style="position: relative;">
              <div id="mapa-ingreso"></div>
              <div class="map-helper-text">
                Haga clic o arrastre el marcador para reubicar
              </div>
            </div>
          </div>

        </div> <div class="row mt-30">
          <div class="col-12">
            <button type="submit" class="btn btn-artista-azul" style="margin-right: 5px;" >Guardar Cambios</button>
            <a href="{% url 'lista_sensores' %}" class="btn btn-artista-rojo">Cancelar</a>
          </div>
        </div>

      </form>
    </div>
  </div>
{% endblock %}


{# --- Bloque 2: SCRIPTS (¡NUEVO!) --- #}
{% block page_scripts %}
  <script src="{% static 'dist/leaflet.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {

      // --- 1. Deshabilitar el campo ID (como en su versión anterior) ---
      const idMqttInput = document.getElementById("{{ form.id_dispositivo_mqtt.id_for_label }}");
      if (idMqttInput) {
        idMqttInput.readOnly = true;
        idMqttInput.style.backgroundColor = "#555";
        idMqttInput.style.cursor = "not-allowed";
      }

      // --- 2. Obtener los campos del formulario ---
      const latInput = document.getElementById('{{ form.latitud.id_for_label }}');
      const lonInput = document.getElementById('{{ form.longitud.id_for_label }}');

      // --- 3. Inicializar el Mapa ---
      const map = L.map('mapa-ingreso').setView([-35.6751, -71.5430], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // --- 4. Inicializar el Marcador ---
      let marker = L.marker([0, 0], { draggable: true }).addTo(map);
      marker.setOpacity(0); // Oculto por defecto

      // --- 5. Clic en el Mapa ---
      map.on('click', function(e) {
        const latlng = e.latlng;
        latInput.value = latlng.lat.toFixed(6);
        lonInput.value = latlng.lng.toFixed(6);
        marker.setLatLng(latlng).setOpacity(1);
        map.panTo(latlng);
      });

      // --- 6. Arrastrar el Marcador ---
      marker.on('dragend', function(e) {
        const latlng = marker.getLatLng();
        latInput.value = latlng.lat.toFixed(6);
        lonInput.value = latlng.lng.toFixed(6);
        map.panTo(latlng);
      });

      // --- 7. EL MOMENTO MÁGICO: Cargar la Ubicación Existente ---
      // Esta es la función que lo convierte en un "Editor"
      function actualizarMapaDesdeInputs() {
        const lat = parseFloat(latInput.value);
        const lon = parseFloat(lonInput.value);

        if (!isNaN(lat) && !isNaN(lon)) {
          const posicionGuardada = [lat, lon];
          marker.setLatLng(posicionGuardada).setOpacity(1);
          // Centramos el mapa en la ubicación guardada con zoom
          map.setView(posicionGuardada, 15); 
        }
      }

      // ¡Llamamos a la función AL CARGAR LA PÁGINA!
      actualizarMapaDesdeInputs();

      // Y también si el usuario escribe a mano (el mismo truco)
      latInput.addEventListener('change', actualizarMapaDesdeInputs);
      lonInput.addEventListener('change', actualizarMapaDesdeInputs);

    });
  </script>
{% endblock %}