{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Ingreso de Dispositivo{% endblock %}

{# --- Bloque 1: ESTILOS --- #}
{% block page_styles %}
  {# Necesitamos el CSS de Leaflet para el mapa interactivo #}
  <link rel="stylesheet" href="{% static 'dist/leaflet.css' %}" />
  <style>
    /* El contenedor del mapa necesita una altura fija */
    #mapa-ingreso {
      height: 450px; 
      width: 100%;
      border-radius: 10px;
      z-index: 1;
      background-color: #555; /* Un fondo mientras carga */
    }
    
    /* Cursor de cruz para indicar "clic para seleccionar" */
    .leaflet-container {
      cursor: crosshair !important;
    }

    /* Un sutil mensaje de ayuda sobre el mapa */
    .map-helper-text {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      z-index: 401; /* Encima del mapa */
      pointer-events: none; /* No interfiere con los clics */
    }

    /* Asegurarnos que los inputs se vean bien en tema oscuro */
    .form-input-dark {
        background-color: #2b2b35; /* Fondo oscuro para input */
        color: #f1f1f1;
        border: 1px solid #444;
    }
    .form-input-dark:focus {
        background-color: #333;
        color: #fff;
        border-color: #007bff;
    }
    
  </style>
{% endblock %}


{% block dashboard_content %}
  <div class="title-wrapper pt-30 mb-20">
 
  <div class="card-style">
    <div class="card-body">
      
      <form method="POST">
        {% csrf_token %}

        <div class="row">

          <div class="col-md-5">
            <h5 class="mb-30">Detalles del Dispositivo</h5>

            <div class="mb-3">
              <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}</label>
              {{ form.nombre }}
            </div>

            <div class="mb-3">
              <label for="{{ form.id_dispositivo_mqtt.id_for_label }}" class="form-label">{{ form.id_dispositivo_mqtt.label }}</label>
              {{ form.id_dispositivo_mqtt }}
            </div>
              {{ form.latitud }}
              {{ form.longitud }}
          </div>

          <div class="col-md-7">
            <div style="position: relative;">
              <div id="mapa-ingreso"></div>
              <div class="map-helper-text">
                Haga clic en el mapa para fijar la ubicación
              </div>
            </div>
          </div>

        </div> <div class="row mt-30">
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Guardar Dispositivo</button>
          </div>
        </div>

      </form>
    </div>
  </div>
{% endblock %}


{# --- Bloque 2: SCRIPTS --- #}
{% block page_scripts %}
  <script src="{% static 'dist/leaflet.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {

      // --- 1. Obtener los campos del formulario ---
      // Asumimos que Django crea los IDs (ej. id_latitud)
      // Si tu form no es de Django, cambia estos selectores.
      const latInput = document.getElementById('{{ form.latitud.id_for_label }}');
      const lonInput = document.getElementById('{{ form.longitud.id_for_label }}');

      // --- 2. Inicializar el Mapa ---
      // Centramos en Chile
      const map = L.map('mapa-ingreso').setView([-35.6751, -71.5430], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // --- 3. Inicializar el Marcador (Marker) ---
      let marker = L.marker([0, 0], { draggable: true }).addTo(map);
      marker.setOpacity(0); // Lo ocultamos al inicio

      // --- 4. LA PINCELADA MAESTRA: Clic en el Mapa ---
      map.on('click', function(e) {
        const latlng = e.latlng;
        
        // Actualizamos los campos del formulario
        latInput.value = latlng.lat.toFixed(6);
        lonInput.value = latlng.lng.toFixed(6);

        // Movemos el marcador a la nueva posición y lo mostramos
        marker.setLatLng(latlng).setOpacity(1);
        map.panTo(latlng);
      });

      // --- 5. EL DETALLE FINO: Arrastrar el Marcador ---
      marker.on('dragend', function(e) {
        const latlng = marker.getLatLng();
        
        // Actualizamos los campos del formulario
        latInput.value = latlng.lat.toFixed(6);
        lonInput.value = latlng.lng.toFixed(6);
        map.panTo(latlng);
      });

      // --- 6. EL TOQUE PRO: Actualizar Mapa si se escribe en los Inputs ---
      function actualizarMapaDesdeInputs() {
        const lat = parseFloat(latInput.value);
        const lon = parseFloat(lonInput.value);

        // Si son números válidos...
        if (!isNaN(lat) && !isNaN(lon)) {
          const nuevaPosicion = [lat, lon];
          marker.setLatLng(nuevaPosicion).setOpacity(1);
          map.setView(nuevaPosicion, 15); // Hacemos zoom
        }
      }

      // Escuchamos cambios en los inputs
      latInput.addEventListener('change', actualizarMapaDesdeInputs);
      lonInput.addEventListener('change', actualizarMapaDesdeInputs);
      
 
      if (latInput.value && lonInput.value) {
        actualizarMapaDesdeInputs();
      }

    });
  </script>
{% endblock %}