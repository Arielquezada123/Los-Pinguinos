{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Ingreso de Dispositivo{% endblock %}

{% block page_styles %}
  <link rel="stylesheet" href="{% static 'dist/leaflet.css' %}" />
  <style>
    #mapa-ingreso {
      height: 450px; 
      width: 100%;
      border-radius: 8px; 
      z-index: 1;
      background-color: #1a233a;
      border: 1px solid #2a3550;
    }
    
    .leaflet-container {
      cursor: crosshair !important;
    }

    @keyframes pulse-light {
      0% { background: rgba(37, 99, 235, 0.8); box-shadow: 0 0 5px rgba(37, 99, 235, 0.8); }
      50% { background: rgba(37, 99, 235, 1); box-shadow: 0 0 15px rgba(37, 99, 235, 1); }
      100% { background: rgba(37, 99, 235, 0.8); box-shadow: 0 0 5px rgba(37, 99, 235, 0.8); }
    }
    .map-helper-text {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.9);
      color: #e0e8f0;
      padding: 8px 16px;
      border-radius: 30px;
      font-size: 0.85em;
      font-weight: 500;
      z-index: 401; 
      pointer-events: none;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
  </style>
{% endblock %}


{% block dashboard_content %}
  
  <div class="row justify-content-center mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-transparent border-bottom border-secondary py-3">
            <h5 class="mb-0 text-white"><i class="lni lni-plus me-2"></i>Nuevo Dispositivo</h5>
        </div>
        <div class="card-body p-4">
          
          <form method="POST" id="ingresoForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
              <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                  <i class="lni lni-warning me-2"></i>{{ error }}
                {% endfor %}
              </div>
            {% endif %}
            

            <div class="row g-4">

              <div class="col-lg-4">
                <h6 class="text-medium mb-3 text-uppercase ls-1" style="letter-spacing: 1px; font-size: 0.75rem;">Información General</h6>
                
                <div class="mb-4">
                  <label for="{{ form.nombre.id_for_label }}" class="form-label">Nombre del Sensor</label>
                  {{ form.nombre }}
                  {% if form.nombre.errors %}
                    <div class="text-danger small mt-1">
                      {% for error in form.nombre.errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}
                  <div class="form-text text-muted small">Asigna un nombre identificable (ej. "Riego Norte").</div>
                </div>

                <div class="mb-4">
                  <label for="{{ form.id_dispositivo_mqtt.id_for_label }}" class="form-label">ID MQTT</label>
                  {{ form.id_dispositivo_mqtt }}
                  {% if form.id_dispositivo_mqtt.errors %}
                    <div class="text-danger small mt-1">
                      {% for error in form.id_dispositivo_mqtt.errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}
                  <div class="form-text text-muted small">El identificador único configurado en el hardware.</div>
                </div>
                
                <div class="d-grid gap-2 mt-5">
                    <button type="submit" class="btn btn-primary py-2">
                        <i class="lni lni-save me-2"></i>Guardar Sensor
                    </button>
                </div>

              </div>

              <div class="col-lg-8">
                <h6 class="text-medium mb-3 text-uppercase ls-1" style="letter-spacing: 1px; font-size: 0.75rem;">Ubicación Geográfica</h6>
                <div style="position: relative;">
                  <div id="mapa-ingreso"></div>
                  <div class="map-helper-text">
                    <i class="lni lni-pointer me-1"></i> Haga clic en el mapa para fijar la ubicación
                  </div>
                </div>
              </div>

            </div> 

            <div style="display: none;">
              {{ form.latitud }}
              {{ form.longitud }}
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{% block page_scripts %}
  <script src="{% static 'dist/leaflet.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {

      const formInputs = document.querySelectorAll('#ingresoForm input[type="text"], #ingresoForm input[type="number"]');
      formInputs.forEach(input => {
          input.classList.add('form-control');
      });

      const latInput = document.getElementById('{{ form.latitud.id_for_label }}');
      const lonInput = document.getElementById('{{ form.longitud.id_for_label }}');

      const map = L.map('mapa-ingreso').setView([-35.6751, -71.5430], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      let marker = L.marker([0, 0], { draggable: true }).addTo(map);
      marker.setOpacity(0); 

      map.on('click', function(e) {
        const latlng = e.latlng;
        latInput.value = latlng.lat.toFixed(6);
        lonInput.value = latlng.lng.toFixed(6);
        marker.setLatLng(latlng).setOpacity(1);
        map.panTo(latlng);
      });

      marker.on('dragend', function(e) {
        const latlng = marker.getLatLng();
        latInput.value = latlng.lat.toFixed(6);
        lonInput.value = latlng.lng.toFixed(6);
        map.panTo(latlng);
      });

      function actualizarMapaDesdeInputs() {
        const lat = parseFloat(latInput.value);
        const lon = parseFloat(lonInput.value);
        if (!isNaN(lat) && !isNaN(lon)) {
          const nuevaPosicion = [lat, lon];
          marker.setLatLng(nuevaPosicion).setOpacity(1);
          map.setView(nuevaPosicion, 15); 
        }
      }
      latInput.addEventListener('change', actualizarMapaDesdeInputs);
      lonInput.addEventListener('change', actualizarMapaDesdeInputs);
      
      if (latInput.value && lonInput.value) {
        actualizarMapaDesdeInputs();
      }

    });
  </script>
{% endblock %}