{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Ingresar Sensor{% endblock %}

{% block page_styles %}
  <link rel="stylesheet" href="{% static 'dist/leaflet.css' %}" />
  <style>
    #map {
        height: 400px;
        border-radius: 10px;
        z-index: 1; /* Asegura que el mapa se vea bien */
    }
  </style>
{% endblock %}


{% block dashboard_content %}
  <div class="title-wrapper pt-30 mb-20" >
    <div class="row align-items-center">
      <div class="col-md-12">
        <h2>Ingresar Nuevo Dispositivo</h2>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-7">
        <form method="POST" id="sensor-form">
            {% csrf_token %}
            
            <div class="card-style mb-30">
                <h6 class="mb-25">Datos del Sensor</h6>
                
                <div class="mb-3">
                    <label class="form-label">{{ form.nombre.label }}</label>
                    {{ form.nombre }}
                </div>
                
                <div class="mb-3">
                    <label class="form-label">{{ form.id_dispositivo_mqtt.label }}</label>
                    {{ form.id_dispositivo_mqtt }}
                    <div id="id_help" class="form-text text-light" style="opacity: 0.7;">
                        ID que envía tu dispositivo
                    </div>
                </div>

                {{ form.latitud }}
                {{ form.longitud }}

                <button type"submit" class="btn btn-primary mt-3">Guardar Dispositivo</button>
            </div>
            
            {% if form.errors %}
                <div class="alert alert-danger">
                    Por favor corrige los errores:
                    {{ form.errors }}
                </div>
            {% endif %}
            
        </form>
    </div>
    
    <div class="col-lg-5">
        <div class="card-style mb-30">
            <h6 class="mb-25">Selecciona la Ubicación</h6>
            <p class="text-light" style="opacity: 0.7;">Haz clic en el mapa para colocar el marcador.</p>
            <div id="map"></div>
        </div>
    </div>
  </div>

{% endblock %}

{% block page_scripts %}
  <script src="{% static 'dist/leaflet.js' %}"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Inicializar el mapa (centrado en una ubicación general)
        const map = L.map('map').setView([-35.42, -71.65], 10); // Centrado en Talca/Maule

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // 2. Referencias a los campos ocultos del formulario
        const latInput = document.getElementById('id_latitud');
        const lonInput = document.getElementById('id_longitud');
        const form = document.getElementById('sensor-form');
        let marker = null;

        // 3. Escuchar clics en el mapa
        map.on('click', function(e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);

            // Actualizar el valor de los inputs ocultos
            latInput.value = lat;
            lonInput.value = lng;

            // Mover el marcador (o crearlo si no existe)
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }
        });
        
        // 4. (Opcional) Validación antes de enviar
        form.addEventListener('submit', function(e) {
            if (!latInput.value || !lonInput.value) {
                e.preventDefault(); // Detener el envío del formulario
                alert('Por favor, selecciona una ubicación en el mapa antes de guardar.');
            }
        });

    });
  </script>
{% endblock %}