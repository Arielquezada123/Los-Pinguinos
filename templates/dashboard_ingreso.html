{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Ingreso de Dispositivo{% endblock %}

{# --- Bloque 1: ESTILOS --- #}
{% block page_styles %}
  <link rel="stylesheet" href="{% static 'dist/leaflet.css' %}" />
  <style>
    #mapa-ingreso {
      height: 450px; 
      width: 100%;
      border-radius: 10px;
      z-index: 1;
      background-color: #555; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* Sombra sutil */
    }
    
    .leaflet-container {
      cursor: crosshair !important;
    }

    @keyframes pulse-light {
      0% { background: rgba(0, 0, 0, 0.7); box-shadow: 0 0 5px rgba(0,0,0,0.7); }
      50% { background: rgba(0, 0, 0, 0.9); box-shadow: 0 0 10px rgba(0,0,0,0.9); }
      100% { background: rgba(0, 0, 0, 0.7); box-shadow: 0 0 5px rgba(0,0,0,0.7); }
    }
    .map-helper-text {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      z-index: 401; 
      pointer-events: none;
      /* ¡Aquí está el aliento de vida! */
      animation: pulse-light 2.5s infinite ease-in-out;
    }

    
    .form-label {
        color: #f1f1f1;
    }
    
    .mb-3 input {
      display: block;
      width: 100%;
      padding: 10px 15px; 
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: #f1f1f1;
      background-color: #1a222a; 
      background-clip: padding-box;
      border: 1px solid #444;
      appearance: none; 
      border-radius: 8px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

  
    .mb-3 input:focus {
      color: #f1f1f1;
      background-color: #1a222a; 
      border-color: #0825df; 
      outline: 0;
      
      box-shadow: 0 0 0 0.25rem rgba(8, 37, 223, 0.3); 
    }

    
    .mb-3 input::placeholder {
      color: #6c757d;
      opacity: 1;
    }
  </style>
{% endblock %}


{% block dashboard_content %}
  
  <div style="margin-top: 15px;" class="card-style">
    <div class="card-body">
      
      <form method="POST">
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div class="alert alert-danger" role="alert">
            {% for error in form.non_field_errors %}
              {{ error }}
            {% endfor %}
          </div>
        {% endif %}
        

        <div class="row">

          <div class="col-md-5">
            <h5 class="mb-30">Detalles del Dispositivo</h5>

            <div class="mb-3">
              <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}</label>
              {{ form.nombre }}
              {% if form.nombre.errors %}
                <div class="text-danger" style="font-size: 0.9em; margin-top: 5px;">
                  {% for error in form.nombre.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label for="{{ form.id_dispositivo_mqtt.id_for_label }}" class="form-label">{{ form.id_dispositivo_mqtt.label }}</label>
              {{ form.id_dispositivo_mqtt }}
              {# --- INICIO DE LA MODIFICACIÓN (Error Específico) --- #}
              {% if form.id_dispositivo_mqtt.errors %}
                <div class="text-danger" style="font-size: 0.9em; margin-top: 5px;">
                  {% for error in form.id_dispositivo_mqtt.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
              
            </div>
            
          </div>

          <div class="col-md-7">
            <h5 class="mb-30">Ubicación</h5>
            <div style="position: relative;">
              <div id="mapa-ingreso"></div>
              <div class="map-helper-text">
                Haga clic en el mapa para fijar la ubicación
              </div>
            </div>
          </div>

        </div> 

        <div style="display: none;">
          {{ form.latitud }}
          {{ form.longitud }}
        </div>

        <div class="row mt-30">
          <div class="col-12">
            <button type="submit" class="btn-artista-azul">Guardar sensor</button>
          </div>
        </div>

      </form>
    </div>
  </div>
{% endblock %}


{% block page_scripts %}
  <script src="{% static 'dist/leaflet.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {

      // --- 1. Obtener los campos OCULTOS ---
      const latInput = document.getElementById('{{ form.latitud.id_for_label }}');
      const lonInput = document.getElementById('{{ form.longitud.id_for_label }}');

      // --- 2. Inicializar el Mapa ---
      const map = L.map('mapa-ingreso').setView([-35.6751, -71.5430], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // --- 3. Inicializar el Marcador (Marker) ---
      let marker = L.marker([0, 0], { draggable: true }).addTo(map);
      marker.setOpacity(0); 

      // --- 4. Clic en el Mapa ---
      map.on('click', function(e) {
        const latlng = e.latlng;
        latInput.value = latlng.lat.toFixed(6);
        lonInput.value = latlng.lng.toFixed(6);
        marker.setLatLng(latlng).setOpacity(1);
        map.panTo(latlng);
      });

      // --- 5. Arrastrar el Marcador ---
      marker.on('dragend', function(e) {
        const latlng = marker.getLatLng();
        latInput.value = latlng.lat.toFixed(6);
        lonInput.value = latlng.lng.toFixed(6);
        map.panTo(latlng);
      });

      // --- 6. Actualizar si se escribe (Aunque están ocultos, es buena práctica) ---
      function actualizarMapaDesdeInputs() {
        const lat = parseFloat(latInput.value);
        const lon = parseFloat(lonInput.value);
        if (!isNaN(lat) && !isNaN(lon)) {
          const nuevaPosicion = [lat, lon];
          marker.setLatLng(nuevaPosicion).setOpacity(1);
          map.setView(nuevaPosicion, 15); 
        }
      }
      latInput.addEventListener('change', actualizarMapaDesdeInputs);
      lonInput.addEventListener('change', actualizarMapaDesdeInputs);
      
      // --- 7. Carga inicial (si el form viene con datos por error/edición) ---
      if (latInput.value && lonInput.value) {
        actualizarMapaDesdeInputs();
      }

    });
  </script>
{% endblock %}