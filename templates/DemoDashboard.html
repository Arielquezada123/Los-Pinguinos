{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>游니 Dashboard de Flujo de Agua</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        body { font-family: Arial; background: #f4f4f4; margin: 20px; }
        h1 { text-align: center; margin-bottom: 40px; }
        .sensor-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .sensor { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 300px; }
        .valor { font-size: 2em; color: #007bff; }
        canvas { width: 100%; height: 150px; }
    </style>
</head>
<body>
    <h1>游니 Flujo de Agua en Tiempo Real</h1>
    <div class="sensor-container" id="sensorContainer">
        <!-- Tarjetas de sensores se generar치n din치micamente -->
    </div>

    <script>
        const ws = new WebSocket("ws://" + window.location.host + "/ws/sensores/");
        const sensors = {};  // guardar치 datos de cada sensor

        ws.onopen = () => console.log("游릭 WebSocket conectado.");
        ws.onclose = () => console.log("游댮 WebSocket desconectado.");
        ws.onerror = (err) => console.error("丘멆잺 Error:", err);

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);  // {cliente_id, sensor_id, flujo}
            const key = data.sensor_id;

            if (!sensors[key]) {
                // Crear tarjeta y gr치fico para este sensor
                const container = document.getElementById("sensorContainer");
                const card = document.createElement("div");
                card.classList.add("sensor");
                card.innerHTML = `
                    <h3>${data.sensor_id} (${data.cliente_id})</h3>
                    <p>Flujo actual: <span class="valor" id="${key}_valor">--</span> L/s</p>
                    <canvas id="${key}_chart"></canvas>
                `;
                container.appendChild(card);

                const ctx = document.getElementById(`${key}_chart`).getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Flujo (L/s)',
                            data: [],
                            borderColor: 'rgba(0,123,255,1)',
                            backgroundColor: 'rgba(0,123,255,0.2)',
                            tension: 0.3,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { x: { display: false }, y: { beginAtZero: true } }
                    }
                });

                sensors[key] = {chart, valores: []};
            }

            // Actualizar valor y gr치fico
            document.getElementById(`${key}_valor`).textContent = data.flujo;
            const sensor = sensors[key];
            sensor.valores.push(data.flujo);

            if (sensor.valores.length > 20) sensor.valores.shift();  // mantener 칰ltimas 20 mediciones
            sensor.chart.data.labels = Array(sensor.valores.length).fill("");
            sensor.chart.data.datasets[0].data = sensor.valores;
            sensor.chart.update();
        };
    </script>
</body>
</html>
