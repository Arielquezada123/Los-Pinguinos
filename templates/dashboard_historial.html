{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Historial de Consumo{% endblock %}

{% block page_styles %}
<style>
  /* Estilo para los botones activos (¡esencial!) */
  .btn-group .btn.btn-primary.active {
    background-color: #007bff;
    color: #fff;
    border-color: #007bff;
  }
  .btn-group .btn.btn-primary:not(.active) {
    background-color: #343a40;
    color: #f1f1f1;
    border-color: #444;
  }
</style>
{% endblock %}


{% block dashboard_content %}



  <div class="card-style" style="margin-top: 20px;">
    <div class="card-body">

      <div class="d-flex justify-content-end mb-3">
        <div class="btn-group" role="group" aria-label="Agrupar por">
          <button type="button" class="btn btn-primary active" id="btn-group-mes">
            Mes
          </button>
          <button type="button" class="btn btn-primary" id="btn-group-semana">
            Semana
          </button>
        </div>
      </div>

      <div style="height: 450px;">
        <canvas id="historialChart"></canvas>
      </div>

    </div>
  </div>

{% endblock %}


{% block page_scripts %}
  
  <script src="{% static 'assets/js/Chart.min.js' %}"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {

      const ctx = document.getElementById('historialChart').getContext('2d');
      const btnMes = document.getElementById('btn-group-mes');
      const btnSemana = document.getElementById('btn-group-semana');
      
      let miGraficoHistorial = null;

      // --- 1. La Paleta de Colores ---
      function generarColorAleatorio() {
        const r = Math.floor(Math.random() * 155) + 100;
        const g = Math.floor(Math.random() * 155) + 100;
        const b = Math.floor(Math.random() * 155) + 100;
        return `rgba(${r}, ${g}, ${b}, 0.7)`;
      }

      async function cargarGrafico(agruparPor) {
        
        // Actualiza el estado visual de los botones
        if (agruparPor === 'mes') {
          btnMes.classList.add('active');
          btnSemana.classList.remove('active');
        } else {
          btnMes.classList.remove('active');
          btnSemana.classList.add('active');
        }

        try {
           
          const response = await fetch(`{% url 'api_reporte_consumo' %}?agrupar_por=${agruparPor}`);
          if (!response.ok) {
            throw new Error('No se pudo cargar la musa (datos)');
          }
          const data = await response.json();

          // Preparar los pigmentos (datasets)
          const datasets = [];
          for (const nombreSensor in data.sensores) {
            const color = generarColorAleatorio();
            datasets.push({
              label: nombreSensor,
              data: data.sensores[nombreSensor],
              borderColor: color,
              // Un color de fondo más sólido para las barras
              backgroundColor: color.replace('0.7', '0.5'), 
              borderWidth: 1
            });
          }

          if (miGraficoHistorial) {
            miGraficoHistorial.destroy();
          }

          miGraficoHistorial = new Chart(ctx, {
            
            type: 'bar', 


            data: {
              labels: data.labels,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  labels: { color: '#f1f1f1' } 
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: '#adb5bd' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: '#adb5bd' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
              }
            }
          });

        } catch (error) {
          console.error("¡La crítica se ha equivocado!", error);
          ctx.font = "20px Arial";
          ctx.fillStyle = "red";
          ctx.textAlign = "center";
          ctx.fillText("Error al cargar la obra.", 150, 100);
        }
      }

      // --- 3. Los Eventos (El Público) ---
      btnMes.addEventListener('click', () => cargarGrafico('mes'));
      btnSemana.addEventListener('click', () => cargarGrafico('semana'));

      // --- 4. La Inauguración (Carga Inicial) ---
      // La obra se revela, en su forma correcta, desde el inicio.
      cargarGrafico('mes');

    });
  </script>
{% endblock %}